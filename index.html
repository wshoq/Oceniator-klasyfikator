<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>streszCzarka</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 750px;
      margin: auto;
      padding: 2rem;
      background: #f8f8f8;
    }
    article {
      background: white;
      padding: 1rem;
      margin-bottom: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
    }
    h2 {
      margin-top: 0;
    }
    .date-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .date-controls button {
      font-size: 1.5rem;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      background-color: #6c757d;
      color: white;
      cursor: pointer;
    }
    .date-controls button:hover {
      background-color: #5a6268;
    }
    input[type="date"] {
      font-size: 1.2rem;
      padding: 0.5rem;
      width: 180px;
    }
    .button-group {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .big-button {
      font-size: 1.2rem;
      padding: 0.75rem 1.5rem;
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .big-button:hover {
      background-color: #b02a37;
    }
    form {
      margin-top: 0.75rem;
      background: #f0f0f0;
      padding: 0.75rem;
      border-radius: 6px;
    }
    form select, form button {
      margin-left: 0.5rem;
      padding: 0.25rem;
    }
  </style>
</head>
<body>
  <h1>üì∞ Krypto Tre≈õci</h1>

  <div class="date-controls">
    <button id="prevDayBtn">‚Üê</button>
    <input type="date" id="datePicker" />
    <button id="nextDayBtn">‚Üí</button>
  </div>

  <div class="button-group">
    <a href="uran.html">
      <button class="big-button">‚ò¢Ô∏è Poka≈º Uran</button>
    </a>
  </div>

  <div id="posts">Wybierz datƒô, aby zobaczyƒá artyku≈Çy.</div>

  <script>
    const SUPABASE_URL = "https://uybpjjqvtcpsxihpbhlp.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5YnBqanF2dGNwc3hpaHBiaGxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0MzMxOTksImV4cCI6MjA2NjAwOTE5OX0.t2amEymFNyEr7bEZ4_p5qX5zxdpx60m3vlyyj2uZkdc";

    const datePicker = document.getElementById('datePicker');
    const container = document.getElementById('posts');
    const prevDayBtn = document.getElementById('prevDayBtn');
    const nextDayBtn = document.getElementById('nextDayBtn');

    function parseTitleDateToISO(titleDate) {
      const [datePart] = titleDate.split(',');
      const [day, month, year] = datePart.trim().split('.');
      return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
    }

    function fetchPosts() {
      container.innerHTML = "≈Åadowanie...";

      fetch(`${SUPABASE_URL}/rest/v1/posts?select=title,content&order=title.desc&limit=100`, {
        headers: {
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        }
      })
      .then(res => res.ok ? res.json() : Promise.reject(`B≈ÇƒÖd sieci: ${res.status}`))
      .then(posts => {
        const selectedDate = datePicker.value;
        if (!selectedDate) {
          container.innerHTML = '<p>Wybierz datƒô, aby zobaczyƒá artyku≈Çy.</p>';
          return;
        }

        const filteredPosts = posts.filter(post => {
          if (!post.title) return false;
          const postDateISO = parseTitleDateToISO(post.title);
          return postDateISO === selectedDate;
        });

        if (filteredPosts.length === 0) {
          container.innerHTML = `<p>Brak artyku≈Ç√≥w na dzie≈Ñ ${selectedDate}.</p>`;
          return;
        }

        container.innerHTML = '';
        filteredPosts.forEach(post => {
          const article = document.createElement('article');
          const parser = new DOMParser();
          const doc = parser.parseFromString(post.content, 'text/html');
          const children = Array.from(doc.body.children);

          const titleEl = document.createElement('h2');
          titleEl.textContent = post.title;
          article.appendChild(titleEl);

          let currentHeader = null;
          let currentContent = [];

          const flushSection = () => {
            if (!currentHeader) return;
            const section = document.createElement('div');

            const header = document.createElement('p');
            header.innerHTML = currentHeader.innerHTML;
            section.appendChild(header);

            currentContent.forEach(el => section.appendChild(el.cloneNode(true)));

            // Link z ostatniego <p> z linkiem, je≈õli istnieje
            const lastLink = section.querySelector('a')?.href || '';

            const form = document.createElement('form');
            form.method = "POST";
            form.action = "https://vps15151.awhost.cloud/webhook-test/oceniator";
            form.innerHTML = `
              <label>Oce≈Ñ ten fragment:
                <select name="Kategoria">
                  <option value="Rynki">Rynki</option>
                  <option value="Prawo">Prawo</option>
                  <option value="Technologie">Technologie</option>
                  <option value="Adopcje">Adopcje</option>
                  <option value="Pozosta≈Çe">Pozosta≈Çe</option>
                </select>
                <input type="hidden" name="nag≈Ç√≥wek" value="${currentHeader.textContent.trim()}">
                <input type="hidden" name="link" value="${lastLink}">
                <button type="submit">Wy≈õlij</button>
              </label>
            `;

            section.appendChild(form);
            article.appendChild(section);
          };

          children.forEach(el => {
            if (el.tagName === 'P' && el.textContent.startsWith('####')) {
              flushSection();
              currentHeader = el;
              currentContent = [];
            } else if (currentHeader) {
              currentContent.push(el);
            } else {
              article.appendChild(el.cloneNode(true));
            }
          });

          flushSection();
          container.appendChild(article);
        });
      })
      .catch(err => {
        console.error(err);
        container.innerHTML = `<p>B≈ÇƒÖd podczas ≈Çadowania post√≥w: ${err}</p>`;
      });
    }

    function shiftDate(days) {
      const current = new Date(datePicker.value);
      current.setDate(current.getDate() + days);
      const iso = current.toISOString().split('T')[0];
      datePicker.value = iso;
      fetchPosts();
    }

    prevDayBtn.addEventListener('click', () => shiftDate(-1));
    nextDayBtn.addEventListener('click', () => shiftDate(1));
    datePicker.addEventListener('change', fetchPosts);

    const today = new Date().toISOString().slice(0, 10);
    datePicker.value = today;
    fetchPosts();
  </script>
</body>
</html>
